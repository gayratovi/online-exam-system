{% extends "base.html" %}

{% block title %}{{ exam.title }} ‚Äî Results | CSSS{% endblock %}

{% block content %}
  {% include "partials/staff_header.html" %}

  <section class="mt-4">
    <h2 class="mb-3">{{ exam.title }} ‚Äî Results</h2>

    <!-- Quick links -->
    <p class="mb-3">
      <a href="{% url 'staff_results_overview' %}" class="btn btn-sm btn-outline-secondary me-2">üìä Results Overview</a>
      <a href="{% url 'staff_exam_question_stats' exam.id %}" class="btn btn-sm btn-outline-info me-2">‚ùì Per-Question Stats</a>
      <a href="{% url 'staff_exam_results_export_csv' exam.id %}" class="btn btn-sm btn-outline-success">‚¨áÔ∏è Export CSV</a>
    </p>

    <!-- Summary -->
    <div class="card p-3 mb-4">
      <div><strong>Total attempts:</strong> {{ total }}</div>
      <div><strong>Completed:</strong> {{ completed }}</div>
      <div><strong>Average score (completed):</strong> {% if avg_score %}{{ avg_score }}%{% else %}‚Äî{% endif %}</div>
    </div>

    {% if attempts %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <colgroup>
            <col style="width: 20%"> <!-- User -->
            <col style="width: 12%"> <!-- Status -->
            <col style="width: 10%"> <!-- Score -->
            <col style="width: 16%"> <!-- Started -->
            <col style="width: 16%"> <!-- Submitted -->
            <col style="width: 14%"> <!-- Time Taken -->
            <col style="width: 12%"> <!-- Detail -->
          </colgroup>
          <thead class="table-dark">
            <tr>
              <th>User</th>
              <th>Status</th>
              <th>Score</th>
              <th>Started</th>
              <th>Submitted</th>
              <th>Time Taken</th>
              <th>Detail</th>
            </tr>
          </thead>
          <tbody>
            {% for a in attempts %}
              <tr>
                <td>{{ a.username }}</td>
                <td>
                  {% if a.status == 'Completed' %}
                    <span class="badge status-badge bg-primary">Completed</span>
                  {% else %}
                    <span class="badge status-badge bg-warning text-dark">In Progress</span>
                  {% endif %}
                </td>
                <td>
                  {% if a.score is not None %}
                    {{ a.score }}%
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>
                <td>{{ a.started_at }}</td>
                <td>{% if a.submitted_at %}{{ a.submitted_at }}{% else %}<span class="text-muted">‚Äî</span>{% endif %}</td>
                <td>{% if a.time_taken %}{{ a.time_taken }}{% else %}<span class="text-muted">‚Äî</span>{% endif %}</td>
                <td>
                  {% if a.status == 'Completed' %}
                    <a href="{% url 'staff_attempt_detail' exam.id a.id %}" class="btn btn-sm btn-outline-primary">View</a>
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">No attempts yet.</div>
    {% endif %}
  </section>
{% endblock %}
