{% extends "base.html" %}

{% block title %}Manage Questions ‚Äì {{ exam.title }} | CSSS{% endblock %}

{% block content %}
  {% include "partials/staff_header.html" %}

  <section class="mx-auto" style="max-width: 800px;">
    <h2 class="mb-1">Manage Questions for <em>{{ exam.title }}</em></h2>
    <p class="text-muted mb-4">{{ exam.module.code }} ‚Äî {{ exam.module.name }}</p>

    <!-- üîπ Add Question Form -->
    <form method="post" class="card p-4 shadow-sm mb-4">
      {% csrf_token %}

      {% if q_form.non_field_errors %}
        <div class="alert alert-danger">{{ q_form.non_field_errors }}</div>
      {% endif %}

      <fieldset class="mb-3">
        <legend class="h6">Add a New Question</legend>

        <div class="mb-3">
          <label for="{{ q_form.question_text.id_for_label }}" class="form-label">Question Text</label>
          <textarea name="{{ q_form.question_text.name }}" id="{{ q_form.question_text.id_for_label }}"
                    class="form-control">{{ q_form.question_text.value|default_if_none:'' }}</textarea>
          {{ q_form.question_text.errors }}
        </div>

        <div class="mb-3">
          <label for="{{ q_form.question_type.id_for_label }}" class="form-label">Question Type</label>
          <select name="{{ q_form.question_type.name }}" id="{{ q_form.question_type.id_for_label }}"
                  class="form-control">
            {% for val, label in q_form.question_type.field.choices %}
              <option value="{{ val }}" {% if q_form.question_type.value == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          {{ q_form.question_type.errors }}
        </div>

        <!-- MCQ Block -->
        <div id="mcq-block">
          <div class="mb-3">
            <label class="form-label">Option A</label>
            <input type="text" name="{{ q_form.option_a.name }}" value="{{ q_form.option_a.value|default_if_none:'' }}" class="form-control">
            {{ q_form.option_a.errors }}
          </div>
          <div class="mb-3">
            <label class="form-label">Option B</label>
            <input type="text" name="{{ q_form.option_b.name }}" value="{{ q_form.option_b.value|default_if_none:'' }}" class="form-control">
            {{ q_form.option_b.errors }}
          </div>
          <div class="mb-3">
            <label class="form-label">Option C</label>
            <input type="text" name="{{ q_form.option_c.name }}" value="{{ q_form.option_c.value|default_if_none:'' }}" class="form-control">
            {{ q_form.option_c.errors }}
          </div>
          <div class="mb-3">
            <label class="form-label">Option D</label>
            <input type="text" name="{{ q_form.option_d.name }}" value="{{ q_form.option_d.value|default_if_none:'' }}" class="form-control">
            {{ q_form.option_d.errors }}
          </div>
          <small class="text-muted">For MCQ, Correct Answer must be A, B, C, or D.</small>
        </div>

        <div class="mb-3">
          <label for="{{ q_form.correct_answer.id_for_label }}" class="form-label">Correct Answer</label>
          <input type="text" name="{{ q_form.correct_answer.name }}" id="{{ q_form.correct_answer.id_for_label }}"
                 value="{{ q_form.correct_answer.value|default_if_none:'' }}" class="form-control">
          {{ q_form.correct_answer.errors }}
        </div>
      </fieldset>

      <button type="submit" class="btn btn-primary w-100">‚ûï Add Question</button>
    </form>

    <!-- üîπ Existing Questions -->
    <h3>Questions in this Exam</h3>
    {% if linked %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Type</th>
              <th>Question</th>
              <th>Options</th>
              <th>Correct</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for link in linked %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ link.question.get_question_type_display }}</td>
                <td>{{ link.question.question_text }}</td>
                <td>
                  {% if link.question.question_type == 'MCQ' %}
                    A) {{ link.question.option_a }}<br>
                    B) {{ link.question.option_b }}<br>
                    C) {{ link.question.option_c }}<br>
                    D) {{ link.question.option_d }}
                  {% else %} ‚Äî {% endif %}
                </td>
                <td>{{ link.question.correct_answer }}</td>
                <td>
                  <a class="btn btn-sm btn-outline-danger"
                     href="{% url 'staff_exam_question_delete' exam.id link.question.id %}"
                     onclick="return confirm('Remove this question from the exam?');">
                     Remove
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">No questions yet ‚Äî add your first one above.</div>
    {% endif %}

    <div class="mt-3 d-flex justify-content-between">
      <a class="btn btn-outline-secondary" href="{% url 'staff_exam_manage' exam.id %}">‚Üê Back to Exam</a>
      <a class="btn btn-primary" href="{% url 'staff_dashboard' %}">Finish</a>
    </div>
  </section>

  <script>
    // Toggle MCQ options dynamically
    const typeSel = document.getElementById('id_question_type');
    const mcqBlock = document.getElementById('mcq-block');
    function toggleMCQ() {
      if (!typeSel || !mcqBlock) return;
      mcqBlock.style.display = (typeSel.value === 'MCQ') ? 'block' : 'none';
    }
    toggleMCQ();
    if (typeSel) typeSel.addEventListener('change', toggleMCQ);
  </script>
{% endblock %}
